
DROP TABLE HRR_AVG_CHG_EXCLUDING_HOSP;

	SELECT a.[PRVDR_NUM],
		   a.[DRG],
		   a.[HRR],
		   (TOT_FY2012_DISCHARGES_PRECEDING + TOT_FY2012_DISCHARGES_FOLLOWING) as [HRR_FY2012_DISCHARGES_EXCLUDING_HOSP],
		   (TOT_FY2012_CHG_PRECEDING + TOT_FY2012_CHG_FOLLOWING)
			/ 
			CASE WHEN (TOT_FY2012_DISCHARGES_PRECEDING + TOT_FY2012_DISCHARGES_FOLLOWING) = 0
			     THEN 1
				 ELSE (TOT_FY2012_DISCHARGES_PRECEDING + TOT_FY2012_DISCHARGES_FOLLOWING) 
			     END as [HRR_FY2012_AVG_CHG_EXCLUDING_HOSP],

		   (TOT_FY2012_ADJUSTED_CHG_PRECEDING + TOT_FY2012_ADJUSTED_CHG_FOLLOWING)
			/ 
			CASE WHEN (TOT_FY2012_DISCHARGES_PRECEDING + TOT_FY2012_DISCHARGES_FOLLOWING) = 0
			     THEN 1
				 ELSE (TOT_FY2012_DISCHARGES_PRECEDING + TOT_FY2012_DISCHARGES_FOLLOWING) 
			     END as [HRR_FY2012_ADJUSTED_AVG_CHG_EXCLUDING_HOSP],

           (TOT_FY2013_DISCHARGES_PRECEDING + TOT_FY2013_DISCHARGES_FOLLOWING) as [HRR_FY2013_DISCHARGES_EXCLUDING_HOSP],
		   (TOT_FY2013_CHG_PRECEDING + TOT_FY2013_CHG_FOLLOWING)
			/ 
			CASE WHEN (TOT_FY2013_DISCHARGES_PRECEDING + TOT_FY2013_DISCHARGES_FOLLOWING) = 0
			     THEN 1
				 ELSE (TOT_FY2013_DISCHARGES_PRECEDING + TOT_FY2013_DISCHARGES_FOLLOWING) 
			     END as [HRR_FY2013_AVG_CHG_EXCLUDING_HOSP],

		   (TOT_FY2013_ADJUSTED_CHG_PRECEDING + TOT_FY2013_ADJUSTED_CHG_FOLLOWING)
			/ 
			CASE WHEN (TOT_FY2013_DISCHARGES_PRECEDING + TOT_FY2013_DISCHARGES_FOLLOWING) = 0
			     THEN 1
				 ELSE (TOT_FY2013_DISCHARGES_PRECEDING + TOT_FY2013_DISCHARGES_FOLLOWING) 
			     END as [HRR_FY2013_ADJUSTED_AVG_CHG_EXCLUDING_HOSP],

           (TOT_FY2014_DISCHARGES_PRECEDING + TOT_FY2014_DISCHARGES_FOLLOWING) as [HRR_FY2014_DISCHARGES_EXCLUDING_HOSP],
		   (TOT_FY2014_CHG_PRECEDING + TOT_FY2014_CHG_FOLLOWING)
			/ 
			CASE WHEN (TOT_FY2014_DISCHARGES_PRECEDING + TOT_FY2014_DISCHARGES_FOLLOWING) = 0
			     THEN 1
				 ELSE (TOT_FY2014_DISCHARGES_PRECEDING + TOT_FY2014_DISCHARGES_FOLLOWING) 
			     END as [HRR_FY2014_AVG_CHG_EXCLUDING_HOSP],

		   (TOT_FY2014_ADJUSTED_CHG_PRECEDING + TOT_FY2014_ADJUSTED_CHG_FOLLOWING)
			/ 
			CASE WHEN (TOT_FY2014_DISCHARGES_PRECEDING + TOT_FY2014_DISCHARGES_FOLLOWING) = 0
			     THEN 1
				 ELSE (TOT_FY2014_DISCHARGES_PRECEDING + TOT_FY2014_DISCHARGES_FOLLOWING) 
			     END as [HRR_FY2014_ADJUSTED_AVG_CHG_EXCLUDING_HOSP]

    INTO HRR_AVG_CHG_EXCLUDING_HOSP
		
	FROM (
		SELECT ip.[PRVDR_NUM],
			   ip.[DRG],
			   ip.[HRR],
			   ISNULL(SUM([N_FY2012_DISCHARGES])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2012_DISCHARGES_PRECEDING,
			   ISNULL(SUM([N_FY2012_DISCHARGES] * [FY2012_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2012_CHG_PRECEDING,
			   ISNULL(SUM([N_FY2012_DISCHARGES] * [FY2012_ADJUSTED_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2012_ADJUSTED_CHG_PRECEDING,
			   ISNULL(SUM([N_FY2013_DISCHARGES])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2013_DISCHARGES_PRECEDING,
			   ISNULL(SUM([N_FY2013_DISCHARGES] * [FY2013_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2013_CHG_PRECEDING,
			   ISNULL(SUM([N_FY2013_DISCHARGES] * [FY2013_ADJUSTED_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2013_ADJUSTED_CHG_PRECEDING,
			   ISNULL(SUM([N_FY2014_DISCHARGES])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2014_DISCHARGES_PRECEDING,
			   ISNULL(SUM([N_FY2014_DISCHARGES] * [FY2014_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2014_CHG_PRECEDING,
			   ISNULL(SUM([N_FY2014_DISCHARGES] * [FY2014_ADJUSTED_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING),0) AS TOT_FY2014_ADJUSTED_CHG_PRECEDING,


			   ISNULL(SUM([N_FY2012_DISCHARGES])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2012_DISCHARGES_FOLLOWING,
			   ISNULL(SUM([N_FY2012_DISCHARGES] * [FY2012_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2012_CHG_FOLLOWING,
			   ISNULL(SUM([N_FY2012_DISCHARGES] * [FY2012_ADJUSTED_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2012_ADJUSTED_CHG_FOLLOWING,
			   ISNULL(SUM([N_FY2013_DISCHARGES])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2013_DISCHARGES_FOLLOWING,
			   ISNULL(SUM([N_FY2013_DISCHARGES] * [FY2013_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2013_CHG_FOLLOWING,
			   ISNULL(SUM([N_FY2013_DISCHARGES] * [FY2013_ADJUSTED_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2013_ADJUSTED_CHG_FOLLOWING,
			   ISNULL(SUM([N_FY2014_DISCHARGES])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2014_DISCHARGES_FOLLOWING,
			   ISNULL(SUM([N_FY2014_DISCHARGES] * [FY2014_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2014_CHG_FOLLOWING,
			   ISNULL(SUM([N_FY2014_DISCHARGES] * [FY2014_ADJUSTED_AVG_CHG])
				   OVER (PARTITION BY [HRR], [DRG] 
				         ORDER BY rn ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING),0) AS TOT_FY2014_ADJUSTED_CHG_FOLLOWING


		from (SELECT *, ROW_NUMBER() OVER (ORDER BY PRVDR_NUM, DRG) rn 
			  FROM W271_IP_CHARGE 
			  
		--where [HRR] = 'AL - Dothan' and [DRG] = '065'    -- test case 1
		--where [PRVDR_NUM] = '020017'                     -- test case 2
		--where [HRR] = 'AK - Anchorage' and [DRG] = '064' -- test case 3
		) as ip
	) as a

-- where [HRR] = 'AK - Anchorage' and [DRG] = '064'        -- should get same answer as test case 2, but without pre-restriction on partition